---
# Prepares Ubuntu VMs for k3s installation.
# Run: ansible-playbook -i inventory/hosts.yml playbooks/prepare-k3s.yml
- name: Prepare nodes for k3s
  hosts: k3s_control_plane
  become: true

  tasks:
    # -- DNS fix --
    # VMs use systemd-resolved which defaults to the router (AdGuard).
    # AdGuard on VLAN 8 is not reachable from VLAN 10, so apt update fails.
    # Workaround: override DNS with public resolvers via drop-in config.
    - name: Ensure resolved.conf.d directory exists
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory
        mode: "0755"

    - name: Configure DNS (systemd-resolved)
      ansible.builtin.copy:
        dest: /etc/systemd/resolved.conf.d/dns.conf
        content: |
          [Resolve]
          DNS=1.1.1.1 8.8.8.8
          FallbackDNS=9.9.9.9
      notify: Restart systemd-resolved

    # Force DNS restart now, before apt needs it
    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    # -- System updates --
    - name: Update apt cache and upgrade packages
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
        cache_valid_time: 3600

    # -- k3s prerequisites --
    # Kubernetes requires swap to be disabled
    - name: Disable swap (runtime)
      ansible.builtin.command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '\sswap\s'
        state: absent

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

  handlers:
    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted
